@page "/login"
@layout AuthenticationLayout
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Sign in</PageTitle>

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />

    <MudCard Elevation="3" Class="pa-5">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Sign in</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudTextField Label="Username or email" @bind-Value="model.Username" For="(() => model.Username)" />
            <MudTextField Label="Password" @bind-Value="model.Password" For="(() => model.Password)" InputType="InputType.Password" />
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Sign in</MudButton>
        </MudCardActions>
    </MudCard>

    <MudCard Elevation="3" Class="pa-5 mt-5">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Trouble accessing your account?</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Secondary">Regain access to your account</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>

@code {
    public class LoginForm
    {
        [Required]
        public string Username {get;set;}
        [Required]
        public string Password {get;set;}
    }

    private LoginForm model = new LoginForm();
    private string error;

    protected override async void OnInitialized()
    {
        if (AuthenticationService.User != null)
            NavigationManager.NavigateTo("/");
    }

    private async void OnValidSubmit()
    {
        try
        {
            await AuthenticationService.Login(model.Username, model.Password);
            var returnUrl = NavigationManager.QueryString("returnUrl") ?? "";
            NavigationManager.NavigateTo(returnUrl);
        }
        catch (Exception ex)
        {
            error = ex.Message;
            Snackbar.Add(error, Severity.Error);
            StateHasChanged();
        }
    }
}