@page "/login"
@layout AuthenticationLayout

<PageTitle>@Localizer["sign-in-title"]</PageTitle>

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />

    <MudCard Elevation="3" Class="pa-5">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@Localizer["sign-in-title"]</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudTextField Label='@Localizer["sign-in-username-placeholder"]' @bind-Value="model.Username" For="(() => model.Username)" />
            <MudTextField Label='@Localizer["sign-in-password-placeholder"]' @bind-Value="model.Password" For="(() => model.Password)" InputType="InputType.Password" />
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">@Localizer["sign-in-button"]</MudButton>
        </MudCardActions>
    </MudCard>

    <MudCard Elevation="3" Class="pa-5 mt-5">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@Localizer["sign-in-forgot-question"]</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Secondary">@Localizer["sign-in-regain-access-button"]</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>

@code {
    public class LoginForm
    {
        [Required]
        public string Username {get;set;}
        [Required]
        public string Password {get;set;}
    }

    private LoginForm model = new LoginForm();
    private string error;

    protected override async void OnInitialized()
    {
        if (AuthenticationService.User != null)
            NavigationManager.NavigateTo("/");
    }

    private async void OnValidSubmit()
    {
        try
        {
            await AuthenticationService.Login(model.Username, model.Password);
            var returnUrl = NavigationManager.QueryString("returnUrl") ?? "";
            NavigationManager.NavigateTo(returnUrl);
        }
        catch (Exception ex)
        {
            error = ex.Message;
            Snackbar.Add(error, Severity.Error);
            StateHasChanged();
        }
    }
}